# TDD 計画書

## 1. テスト方針

### 1.1 テスト戦略

- **テスト駆動開発（TDD）** の原則に従い、実装前にテストを記述する
- **レッド・グリーン・リファクタ** のサイクルを繰り返す
- 単体テスト、統合テスト、ユーザーインタラクションテストを段階的に実装する

### 1.2 テスト環境

- **テストフレームワーク**: Vitest
- **React テストライブラリ**: @testing-library/react
- **DOM 環境**: jsdom

### 1.3 テストカバレッジ目標

- コンポーネントの主要機能: 100%
- ユーザーインタラクション: 100%
- エッジケース: 可能な限り網羅

## 2. テスト実装順序

### Phase 1: データ構造とユーティリティ

1. `TimeRange` データ構造のバリデーション
2. 座標マッピング関数のテスト

### Phase 2: TimeBox コンポーネント

1. レンダリングテスト
2. ドラッグ操作のテスト
3. リサイズ操作のテスト
4. 削除操作のテスト

### Phase 3: Timeline コンポーネント

1. レンダリングテスト
2. 区間作成のテスト
3. 区間管理のテスト
4. コールバック関数のテスト

### Phase 4: 統合テスト

1. エンドツーエンドのユーザー操作フロー
2. 複数区間の操作
3. エッジケースのテスト

## 3. テストケース詳細

### 3.1 TimeRange データ構造

#### 3.1.1 バリデーションテスト

- [ ] `start` が `end` より小さい場合、有効な TimeRange として扱える
- [ ] `start` が `end` と等しい場合、エラー
- [ ] `start` が `end` より大きい場合、エラー
- [ ] `start` が負数の場合、エラー
- [ ] `name` が空文字列の場合の扱い
- [ ] `color` が未指定の場合、デフォルト色が適用される
- [ ] `color` が有効な CSS カラー値の場合、正しく保存される

#### 3.1.2 ユーティリティ関数テスト

- [ ] TimeRange の長さ（duration）を計算する関数
- [ ] TimeRange が重複しているか判定する関数
- [ ] TimeRange をマージする関数（必要に応じて）

### 3.2 座標マッピング関数

#### 3.2.1 時間から座標への変換

- [ ] `min` が 0、`max` が 100 の場合、50 は中央にマッピングされる
- [ ] `min` が 10、`max` が 20 の場合、15 は中央にマッピングされる
- [ ] タイムラインの幅が 1000px の場合、正しいピクセル値に変換される
- [ ] 負の値や範囲外の値の扱い

#### 3.2.2 座標から時間への変換

- [ ] タイムラインの左端（0px）が `min` にマッピングされる
- [ ] タイムラインの右端（1000px）が `max` にマッピングされる
- [ ] 中央の座標が正しい時間値にマッピングされる
- [ ] 範囲外の座標の扱い

### 3.3 TimeBox コンポーネント

#### 3.3.1 レンダリングテスト

- [ ] `name` が正しく表示される
- [ ] `color` が背景色として適用される
- [ ] `left` と `width` で正しい描画位置につく
- [ ] 削除ボタンが表示される

#### 3.3.2 ドラッグ操作テスト

- [ ] 中央部分をドラッグすると、`onMove` が呼ばれる
- [ ] ドラッグ距離が `dragUnit` の倍数にスナップされる
- [ ] ドラッグ中に `onMove` が適切な間隔で呼ばれる
- [ ] ドラッグがタイムラインの範囲外に出た場合の処理

#### 3.3.3 リサイズ操作テスト

- [ ] 左端をドラッグすると、`onResize` が `start` 変更で呼ばれる
- [ ] 右端をドラッグすると、`onResize` が `end` 変更で呼ばれる
- [ ] リサイズ時に `start` が `end` を超えないように制限される
- [ ] リサイズ距離が `dragUnit` の倍数にスナップされる
- [ ] 最小幅の制限が正しく機能する

#### 3.3.4 削除操作テスト

- [ ] 削除ボタンをクリックすると、`onDelete` が呼ばれる
- [ ] 削除確認ダイアログの表示（必要に応じて）

### 3.4 Timeline コンポーネント

#### 3.4.1 レンダリングテスト

- [ ] `min` と `max` に基づいてタイムラインが描画される
- [ ] `grid` に基づいてグリッド線が表示される
- [ ] ラベルが正しいフォーマットで表示される
- [ ] 複数の `TimeRange` が正しく `TimeBox` として描画される
- [ ] 空の `timeRanges` 配列の場合、タイムラインのみが表示される

#### 3.4.2 区間作成テスト

- [ ] タイムライン上で `mousedown` すると、新しい区間の作成が開始される
- [ ] `mousemove` 中に仮の区間が表示される
- [ ] `mouseup` で区間が確定され、`timeRanges` に追加される
- [ ] `onTimeRangesChange` が正しい引数で呼ばれる
- [ ] 作成中の区間が最小幅未満の場合、区間が作成されない
- [ ] 作成中の区間がタイムラインの範囲外に出た場合の処理

#### 3.4.3 区間管理テスト

- [ ] `TimeBox` からの `onMove` 呼び出しで区間が移動する
- [ ] `TimeBox` からの `onResize` 呼び出しで区間がリサイズされる
- [ ] `TimeBox` からの `onDelete` 呼び出しで区間が削除される
- [ ] 区間の移動・リサイズ時に他の区間と重複しないように制限される（必要に応じて）
- [ ] 区間がタイムラインの範囲外に移動できないように制限される

#### 3.4.4 コールバック関数テスト

- [ ] `onTimeRangesChange` が区間の作成時に呼ばれる
- [ ] `onTimeRangesChange` が区間の移動時に呼ばれる
- [ ] `onTimeRangesChange` が区間のリサイズ時に呼ばれる
- [ ] `onTimeRangesChange` が区間の削除時に呼ばれる
- [ ] コールバックに渡される `timeRanges` が正しい状態である

#### 3.4.5 ラベルフォーマットテスト

- [ ] カスタムフォーマット関数が正しく適用される
- [ ] デフォルトフォーマットが正しく表示される
- [ ] 異なる時間単位（秒、分、時間、フレーム）での表示

### 3.5 統合テスト

#### 3.5.1 エンドツーエンド操作フロー

- [ ] 区間を作成 → 移動 → リサイズ → 削除の一連の操作
- [ ] 複数の区間を連続して作成する操作
- [ ] 区間を移動して他の区間と重複させようとした場合の処理

#### 3.5.2 エッジケース

- [ ] `min` と `max` が等しい場合
- [ ] `min` が `max` より大きい場合（エラーハンドリング）
- [ ] `timeRanges` に重複する区間が含まれる場合
- [ ] 非常に長い `name` の表示
- [ ] 非常に短い区間（1ピクセル未満）の作成
- [ ] タイムラインの幅が 0 または非常に小さい場合

## 4. テストファイル構成

```text
src/
├── __tests__/
│   ├── TimeRange.test.ts
│   ├── utils/
│   │   └── coordinateMapping.test.ts
│   ├── components/
│   │   ├── TimeBox.test.tsx
│   │   └── Timeline.test.tsx
│   └── integration/
│       └── Timeline.integration.test.tsx
├── types/
│   └── TimeRange.ts
├── utils/
│   └── coordinateMapping.ts
└── components/
    ├── TimeBox.tsx
    └── Timeline.tsx
```

## 5. テスト実装のベストプラクティス

### 5.1 テストの記述方針

- **AAA パターン**（Arrange, Act, Assert）を使用
- テスト名は「何をテストするか」を明確に記述
- 各テストは独立して実行可能にする

### 5.2 モックとスパイ

- ユーザーイベントは `@testing-library/user-event` を使用
- コールバック関数は `vi.fn()` でモック化
- DOM イベントは `fireEvent` または `userEvent` を使用

### 5.3 アクセシビリティテスト

- `getByRole`、`getByLabelText` などのセマンティッククエリを優先
- キーボード操作のテストも含める

## 6. 継続的改善

### 6.1 テストメンテナンス

- 新機能追加時は必ずテストを追加
- リファクタリング時はテストを更新
- 定期的にテストカバレッジを確認

### 6.2 テストの実行

- 開発中は `vitest --watch` で継続的にテストを実行
- CI/CD パイプラインで全テストを実行
- コミット前にテストが通ることを確認
